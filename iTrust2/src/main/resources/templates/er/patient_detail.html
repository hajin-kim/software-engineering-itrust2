<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:include="layout :: head(title=~{::title}, links=~{})">
  <title>Patient Details</title>
  <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.4/angular.min.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
</head>
<body th:include="layout :: body" th:with="content=~{::content}">
<div th:fragment="content">
  <script th:inline="javascript">
    var app = angular.module('patientDetailApp', []);

    app.controller('patientDetailController', function ($scope, $http, $window) {
      $scope.selectedPatient = {};
      $scope.recentDiagnoses = [];
      $scope.recentPrescriptions = [];
      $scope.message = '';

      $scope.init = function () {
        var username = $window.location.search.split('=')[1];
        if (username) {
          $http.get('/iTrust2/api/v1/emergency/patients/' + username)
                  .then(function (response) {
                    $scope.selectedPatient = response.data;
                    return $http.get('/iTrust2/api/v1/emergency/patients/' + username + '/recentDiagnoses');
                  })
                  .then(function (response) {
                    $scope.recentDiagnoses = response.data;
                    return $http.get('/iTrust2/api/v1/emergency/patients/' + username + '/recentPrescriptions');
                  })
                  .then(function (response) {
                    $scope.recentPrescriptions = response.data;
                  })
                  .catch(function (rejection) {
                    $scope.message = 'Unable to get detailed patient information.';
                  });
        } else {
          $scope.message = 'Username not provided.';
        }
      };

      $scope.init();
    });
  </script>

  <div ng-app="patientDetailApp" ng-controller="patientDetailController">
    <h1>Patient Details</h1>

    <!-- Display Patient Details -->
    <div ng-if="selectedPatient.username">
      <p><strong>Username:</strong> {{selectedPatient.username}}</p>
      <p><strong>Name:</strong>{{selectedPatient.firstName}} {{selectedPatient.lastName}}</p>
      <p><strong>Age:</strong> {{calculateAge(selectedPatient.dateOfBirth)}}</p>
      <p><strong>Date of birth:</strong>{{selectedPatient.dateOfBirth}}</p>
      <p><strong>Gender:</strong>{{selectedPatient.gender}}</p>
      <p><strong>Blood type:</strong> {{selectedPatient.bloodType}}</p>
    </div>

    <!-- Display Recent Diagnoses -->
    <div ng-if="recentDiagnoses.length > 0">
      <h3>Recent Diagnoses</h3>
      <ul>
        <li ng-repeat="diagnosis in recentDiagnoses">{{diagnosis.id}}</li>
      </ul>
    </div>

    <!-- Display Recent Prescriptions -->
    <div ng-if="recentPrescriptions.length > 0">
      <h3>Recent Prescriptions</h3>
      <ul>
        <li ng-repeat="prescription in recentPrescriptions">{{prescription.id}}</li>
      </ul>
    </div>

    <!-- Display Error Message -->
    <p ng-if="message">{{message}}</p>
  </div>
</div>
</body>
</html>
